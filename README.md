# Publish-virtual-machine-events-using-MQTT
本项目在linux环境下使用C语言开发，应对云计算场景中，计算节点和管理节点分离，当我们在计算节点上，对虚拟机进行操作时，管理节点是没有任何感知。这样的话，就不便于管理人员通过前端的任务记录，对出现的问题进行分析。为了让管理节点能够感知到计算节点发生的变化，当我们对虚拟机进行操作时，以libvirt evnet的形式发布给到管理节点，上层根据event信息，生成任务记录，便于后续的问题排查。

## 1. 前言
网络技术不断发展，网络中存在的攻击行为也层出不穷，恶意攻击者作为中间人窃取网络信息，篡改网络信息，或者冒充合法服务器对合法用户实施攻击。因此，我们设计网络协议，和部署网络通信服务器时，必须重点考虑网络安全问题。在这样的背景下TLS协议运行而生，TLS协议工作在传输层和应用层之间，能够为上层应用提供数据加密，数据完整性验证和用户验证等功能，因此广泛的应用于网络通信中。

MQTT（Message Queuing Telemetry Transport，消息队列遥测传输协议），是一种基于发布/订阅（publish/subscribe）模式的轻量级协议，该协议构建于TCP/IP协议之上，MQTT最大优点在于，可以以极少的代码和有限的带宽，为连接远程设备提供实时可靠的消息服务。

该协议默认情况下，以明文的形式进行消息的发布。因此，在本章节中，将通过TLS协议对MQTT发布的信息进行加密，确保消息的安全传输，保证数据的保密性和数据保证性。

本项目最终目的是，当在计算节点对虚拟机进行操作时，即虚拟机的状态发生变化时，发布者(即计算节点)会以事件的形式，通知到订阅者(即，管理节点)，发布的事件信息通过TLS协议进行加密。

## 2. libvirt简介
libvirt是目前使用最为广泛的对KVM虚拟机继续管理的工具和应用程序接口，而且一些常用的虚拟机管理工具（如virsh、virt-manager等）和云计算框架平台（如：OpenStack、ZStack等）都在底层使用libvirt的应用程序接口。
libvirt是为了更方便地管理平台虚拟化技术而设计的开放源代码的应用程序接口(libvirt API)、守护进程(libvirtd)和管理工具(virsh)，它不仅提供了对虚拟化客户机的管理，也提供了对虚拟化网络和存储的管理。
libvirt支持事件机制，在使用该机制注册之后，可以在发生特定的事件（如：domain的启动、暂停、恢复和停止等）时得到自己定义的一些通知。该功能由以virStream开头的一系列函数实现。

## 3. MQTT简介
实现MQTT协议需要客户端和服务器端通讯完成，在通讯过程中，MQTT协议中有三种身份：发布者（ publisher ）、代理（broker）、订阅者（subscriber）。
其中，消息的发布者和订阅者都是客户端，消息代理是服务器，消息发布者可以同时是订阅者。
MQTT传输的消息分为：主题（Topic）和负载（payload）两部分：
（1）Topic：订阅的主题，即channel，频道；
（2）payload：消息的内容，发布者向订阅者发布的具体消息。

## 4. 网络安全的四个原则
机密性：网络中传递的数据，经过加密算法进行加密；就算中间人窃听，他也无法获取其中的内容；

完整性：指数据传输过程中，没有被篡改，就算被篡改，也能检测出来；

身份认证：能够确认对方的身份的合法性；

不可否认：对自己操作过的网络行为，不能否认。
